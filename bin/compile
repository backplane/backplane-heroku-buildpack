#!/bin/sh

set -e

buildDir=$1
cacheDir=$2
envDir=$3

mkdir -p $buildDir/bin
mkdir -p $buildDir/.profile.d
mkdir -p $cacheDir
mkdir -p $envDir

install_backplane() {
  echo "-----> Installing Backplane Agent"
  name=backplane-stable-linux-amd64.tgz
  curl -s https://bin.equinox.io/c/jWahGASjoRq/$name > $cacheDir/$name
  tar xf $cacheDir/$name -C $buildDir/bin
}

install_backplane

if [ -f $envDir/BACKPLANE_ALLOW_PROCESS_TYPES ]; then 
  whitelist=$(cat $envDir/BACKPLANE_ALLOW_PROCESS_TYPES)
fi
whitelist=${whitelist:-web,www}
echo "-----> Backplane Agent whitelists 'web' and 'www' process types by default."
echo "       Use enviroment variable BACKPLANE_ALLOW_PROCESS_TYPES to whitelist alternate process types."
echo "       Example: BACKPLANE_ALLOW_PROCESS_TYPES=internal,external"
echo ""
echo "-----> Backplane Agent whitelisted process types: $whitelist"
echo ""

if [ -f $envDir/BACKPLANE_LABELS ]; then 
  labels="$(cat $envDir/BACKPLANE_LABELS), heroku=true"
else
  labels="heroku=true"
fi
echo "-----> Backplane labels: $labels"
echo ""

echo "-----> Writing .profile.d/backplane.sh"
cat <<-EOF > $buildDir/.profile.d/backplane.sh
CURRENT_PROCESS_TYPE=\${DYNO%.*}
IFS=", " read -r -a array <<< "$whitelist"
for element in "\${array[@]}"
do
  if [ "\$element" == "\$CURRENT_PROCESS_TYPE" ]; then
    echo "[backplane] Starting Backplane Agent for \"$labels\""
    \$HOME/bin/backplane connect "$labels" http://127.0.0.1:\$PORT &
    echo "[backplane] Backplane Agent running"
    exit 0
  fi
done
echo '[backplane] Skipping start of Backplane Agent'
EOF